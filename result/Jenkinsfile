pipeline{
  agent none
  
  stages{
    
    stage(build){
      agent{
        docker{
        image "node:8.9-alpine"
        }
      }

      when{
       changeset "**/result/**"
      }

      steps{
        dir('result'){
          echo 'building result app'
          sh 'npm install'
         
        }
      }
    }
    
    stage(test){
      agent{
        docker{
          image "node:8.9-alpine"
        }
      }

      when{ changeset "**/result/**"}
      
      steps{
        dir('result'){
          echo 'testing result-app'
          sh 'npm install'
          sh 'npm test'
        }
      }
    }
   
    /* in this course branch feature/builds contains a slash and it doess't work with docker tag name, instead use branch master */  
    stage("docker-build"){
      agent any
      
      when{ 
        changeset "**/result/**" 
        branch "master"
      }
    
      steps{
        echo "Using docker to package"
        script{
          docker.withRegistry('https://index.docker.io/v1/', 'dockerlogin') {
            def voteImage = docker.build("abrahambelloso/result:v${env.BUILD_ID}", "./result")
            voteImage.push()
            voteImage.push("${env.BRANCH_NAME}")
          }
        }
      }
    }
  }

  post{
    always{
      echo 'result pipeline completed...'
    }
    success{
      slackSend (channel: "lfs261", message: "Build Succeeded - ${env.JOB_NAME} ${env.BUILD_NUMBER} (<${env.BUILD_URL}|Open>)")
    }
    failure{
      slackSend (channel: "lfs261", message: "Build Failed! - ${env.JOB_NAMe} ${env.BUILD_NUMBER} (<${env.BUILD_URL}|Open)")
    }
  }
}
